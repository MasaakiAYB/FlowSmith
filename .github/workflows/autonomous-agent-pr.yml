name: 自律エージェント PR

on:
  workflow_dispatch:
    inputs:
      issue_number:
        description: "対象の GitHub Issue 番号"
        required: true
        type: string
      project_id:
        description: ".agent/projects.json の project id"
        required: false
        default: ""
        type: string
      target_repo:
        description: "任意: 対象リポジトリ（owner/repo）。project設定より優先"
        required: false
        default: ""
        type: string
      base_branch:
        description: "任意: ベースブランチの上書き"
        required: false
        default: ""
        type: string
      branch_name:
        description: "任意: 作業ブランチの上書き"
        required: false
        default: ""
        type: string
      feedback_pr_number:
        description: "任意: 改善指摘を抽出する対象PR番号（対象repo側）"
        required: false
        default: ""
        type: string
      feedback_text:
        description: "任意: 追加入力する改善指摘テキスト"
        required: false
        default: ""
        type: string
      no_sync:
        description: "任意: 同期をスキップ"
        required: false
        default: false
        type: boolean

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  run-agent:
    uses: ./.github/workflows/autonomous-agent-runner.yml
    with:
      dispatch_mode: ${{ inputs.feedback_pr_number != '' && 'feedback' || 'issue' }}
      issue_number: ${{ inputs.issue_number }}
      project_id: ${{ inputs.project_id }}
      target_repo: ${{ inputs.target_repo }}
      base_branch: ${{ inputs.base_branch }}
      branch_name: ${{ inputs.branch_name }}
      feedback_pr_number: ${{ inputs.feedback_pr_number }}
      feedback_text: ${{ inputs.feedback_text }}
      no_sync: ${{ inputs.no_sync }}
      allow_no_changes: ${{ inputs.feedback_pr_number != '' }}
      source_repository: ${{ github.repository }}
      request_id: ${{ format('manual-{0}-{1}', github.run_id, github.run_attempt) }}
    secrets: inherit
