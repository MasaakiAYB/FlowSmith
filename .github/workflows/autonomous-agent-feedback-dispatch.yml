name: 自律エージェント ディスパッチ受け口（Feedback）

on:
  repository_dispatch:
    types:
      - autonomous-agent-feedback-request

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  validate-payload:
    runs-on: ubuntu-latest
    outputs:
      issue_number: ${{ steps.payload.outputs.issue_number }}
      project_id: ${{ steps.payload.outputs.project_id }}
      target_repo: ${{ steps.payload.outputs.target_repo }}
      base_branch: ${{ steps.payload.outputs.base_branch }}
      branch_name: ${{ steps.payload.outputs.branch_name }}
      feedback_pr_number: ${{ steps.payload.outputs.feedback_pr_number }}
      source_repository: ${{ steps.payload.outputs.source_repository }}
      request_id: ${{ steps.payload.outputs.request_id }}
      feedback_text: ${{ steps.payload.outputs.feedback_text }}
      no_sync: ${{ steps.payload.outputs.no_sync }}
    steps:
      - name: ペイロード検証（Feedback）
        id: payload
        run: |
          set -euo pipefail

          issue_number="$(jq -r '.client_payload.issue_number // empty | tostring' "$GITHUB_EVENT_PATH")"
          project_id="$(jq -r '.client_payload.project_id // empty | tostring' "$GITHUB_EVENT_PATH")"
          target_repo="$(jq -r '.client_payload.target_repo // empty | tostring' "$GITHUB_EVENT_PATH")"
          base_branch="$(jq -r '.client_payload.base_branch // empty | tostring' "$GITHUB_EVENT_PATH")"
          branch_name="$(jq -r '.client_payload.branch_name // empty | tostring' "$GITHUB_EVENT_PATH")"
          feedback_pr_number="$(jq -r '.client_payload.feedback_pr_number // empty | tostring' "$GITHUB_EVENT_PATH")"
          source_repository="$(jq -r '.client_payload.source_repository // empty | tostring' "$GITHUB_EVENT_PATH")"
          request_id="$(jq -r '.client_payload.request_id // empty | tostring' "$GITHUB_EVENT_PATH")"
          feedback_text="$(jq -r '.client_payload.feedback_text // empty | tostring' "$GITHUB_EVENT_PATH")"
          no_sync_raw="$(jq -r '.client_payload.no_sync // false | tostring' "$GITHUB_EVENT_PATH")"

          if ! [[ "$issue_number" =~ ^[0-9]+$ ]]; then
            echo "client_payload.issue_number は正の整数で指定してください。" >&2
            exit 1
          fi

          if [ -z "$project_id" ] && [ -z "$target_repo" ]; then
            echo "client_payload.project_id または client_payload.target_repo のどちらかは必須です。" >&2
            exit 1
          fi

          if ! [[ "$feedback_pr_number" =~ ^[0-9]+$ ]]; then
            echo "client_payload.feedback_pr_number は正の整数で必須です。" >&2
            exit 1
          fi

          if [ -z "$branch_name" ]; then
            echo "client_payload.branch_name は Feedback 入口では必須です。" >&2
            exit 1
          fi

          if [ -z "$base_branch" ]; then
            echo "client_payload.base_branch は Feedback 入口では必須です。" >&2
            exit 1
          fi

          expected_secret="${{ secrets.DISPATCH_SHARED_SECRET }}"
          if [ -n "$expected_secret" ]; then
            provided_secret="$(jq -r '.client_payload.dispatch_secret // empty | tostring' "$GITHUB_EVENT_PATH")"
            if [ -z "$provided_secret" ] || [ "$provided_secret" != "$expected_secret" ]; then
              echo "dispatch_secret の検証に失敗しました。" >&2
              exit 1
            fi
          fi

          no_sync="false"
          if [ "$no_sync_raw" = "true" ] || [ "$no_sync_raw" = "1" ]; then
            no_sync="true"
          fi

          echo "issue_number=$issue_number" >> "$GITHUB_OUTPUT"
          echo "project_id=$project_id" >> "$GITHUB_OUTPUT"
          echo "target_repo=$target_repo" >> "$GITHUB_OUTPUT"
          echo "base_branch=$base_branch" >> "$GITHUB_OUTPUT"
          echo "branch_name=$branch_name" >> "$GITHUB_OUTPUT"
          echo "feedback_pr_number=$feedback_pr_number" >> "$GITHUB_OUTPUT"
          echo "source_repository=$source_repository" >> "$GITHUB_OUTPUT"
          echo "request_id=$request_id" >> "$GITHUB_OUTPUT"
          echo "no_sync=$no_sync" >> "$GITHUB_OUTPUT"
          {
            echo "feedback_text<<EOF"
            printf '%s\n' "$feedback_text"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: サマリー（Feedback）
        if: ${{ always() }}
        run: |
          {
            echo "## 受信ペイロード（Feedback）"
            echo ""
            echo "- issue_number: \`${{ steps.payload.outputs.issue_number || '未指定' }}\`"
            echo "- project_id: \`${{ steps.payload.outputs.project_id || '未指定' }}\`"
            echo "- target_repo: \`${{ steps.payload.outputs.target_repo || '未指定' }}\`"
            echo "- base_branch: \`${{ steps.payload.outputs.base_branch || '未指定' }}\`"
            echo "- branch_name: \`${{ steps.payload.outputs.branch_name || '未指定' }}\`"
            echo "- feedback_pr_number: \`${{ steps.payload.outputs.feedback_pr_number || '未指定' }}\`"
            echo "- no_sync: \`${{ steps.payload.outputs.no_sync || 'false' }}\`"
          } >> "$GITHUB_STEP_SUMMARY"

  run-agent:
    needs: validate-payload
    uses: ./.github/workflows/autonomous-agent-runner.yml
    with:
      dispatch_mode: feedback
      issue_number: ${{ needs.validate-payload.outputs.issue_number }}
      project_id: ${{ needs.validate-payload.outputs.project_id }}
      target_repo: ${{ needs.validate-payload.outputs.target_repo }}
      base_branch: ${{ needs.validate-payload.outputs.base_branch }}
      branch_name: ${{ needs.validate-payload.outputs.branch_name }}
      feedback_pr_number: ${{ needs.validate-payload.outputs.feedback_pr_number }}
      source_repository: ${{ needs.validate-payload.outputs.source_repository }}
      request_id: ${{ needs.validate-payload.outputs.request_id }}
      feedback_text: ${{ needs.validate-payload.outputs.feedback_text }}
      no_sync: ${{ needs.validate-payload.outputs.no_sync == 'true' }}
      allow_no_changes: true
    secrets: inherit
