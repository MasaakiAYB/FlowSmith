name: 自律エージェント ディスパッチ受け口（Issue）

on:
  repository_dispatch:
    types:
      - autonomous-agent-issue-request

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  validate-payload:
    runs-on: ubuntu-latest
    outputs:
      issue_number: ${{ steps.payload.outputs.issue_number }}
      project_id: ${{ steps.payload.outputs.project_id }}
      target_repo: ${{ steps.payload.outputs.target_repo }}
      base_branch: ${{ steps.payload.outputs.base_branch }}
      branch_name: ${{ steps.payload.outputs.branch_name }}
      codex_auth_json_b64: ${{ steps.payload.outputs.codex_auth_json_b64 }}
      source_repository: ${{ steps.payload.outputs.source_repository }}
      request_id: ${{ steps.payload.outputs.request_id }}
      no_sync: ${{ steps.payload.outputs.no_sync }}
      duplicate_request: ${{ steps.dedupe.outputs.duplicate_request }}
    steps:
      - name: ペイロード検証（Issue）
        id: payload
        run: |
          set -euo pipefail

          issue_number="$(jq -r '.client_payload.issue_number // empty | tostring' "$GITHUB_EVENT_PATH")"
          project_id="$(jq -r '.client_payload.project_id // empty | tostring' "$GITHUB_EVENT_PATH")"
          target_repo="$(jq -r '.client_payload.target_repo // empty | tostring' "$GITHUB_EVENT_PATH")"
          base_branch="$(jq -r '.client_payload.base_branch // empty | tostring' "$GITHUB_EVENT_PATH")"
          branch_name="$(jq -r '.client_payload.branch_name // empty | tostring' "$GITHUB_EVENT_PATH")"
          codex_auth_json_b64="$(jq -r '.client_payload.codex_auth_json_b64 // empty | tostring' "$GITHUB_EVENT_PATH")"
          source_repository="$(jq -r '.client_payload.source_repository // empty | tostring' "$GITHUB_EVENT_PATH")"
          request_id="$(jq -r '.client_payload.request_id // empty | tostring' "$GITHUB_EVENT_PATH")"
          no_sync_raw="$(jq -r '.client_payload.no_sync // false | tostring' "$GITHUB_EVENT_PATH")"

          feedback_pr_number="$(jq -r '.client_payload.feedback_pr_number // empty | tostring' "$GITHUB_EVENT_PATH")"
          feedback_text="$(jq -r '.client_payload.feedback_text // empty | tostring' "$GITHUB_EVENT_PATH")"

          if ! [[ "$issue_number" =~ ^[0-9]+$ ]]; then
            echo "client_payload.issue_number は正の整数で指定してください。" >&2
            exit 1
          fi

          if [ -z "$project_id" ] && [ -z "$target_repo" ]; then
            echo "client_payload.project_id または client_payload.target_repo のどちらかは必須です。" >&2
            exit 1
          fi

          if [ -n "$feedback_pr_number" ] || [ -n "$feedback_text" ]; then
            echo "Issue入口では feedback_pr_number / feedback_text は指定できません。" >&2
            exit 1
          fi

          expected_secret="${{ secrets.DISPATCH_SHARED_SECRET }}"
          if [ -n "$expected_secret" ]; then
            provided_secret="$(jq -r '.client_payload.dispatch_secret // empty | tostring' "$GITHUB_EVENT_PATH")"
            if [ -z "$provided_secret" ] || [ "$provided_secret" != "$expected_secret" ]; then
              echo "dispatch_secret の検証に失敗しました。" >&2
              exit 1
            fi
          fi

          no_sync="false"
          if [ "$no_sync_raw" = "true" ] || [ "$no_sync_raw" = "1" ]; then
            no_sync="true"
          fi

          echo "issue_number=$issue_number" >> "$GITHUB_OUTPUT"
          echo "project_id=$project_id" >> "$GITHUB_OUTPUT"
          echo "target_repo=$target_repo" >> "$GITHUB_OUTPUT"
          echo "base_branch=$base_branch" >> "$GITHUB_OUTPUT"
          echo "branch_name=$branch_name" >> "$GITHUB_OUTPUT"
          if [ -n "$codex_auth_json_b64" ]; then
            echo "::add-mask::$codex_auth_json_b64"
          fi
          echo "codex_auth_json_b64=$codex_auth_json_b64" >> "$GITHUB_OUTPUT"
          echo "source_repository=$source_repository" >> "$GITHUB_OUTPUT"
          echo "request_id=$request_id" >> "$GITHUB_OUTPUT"
          echo "no_sync=$no_sync" >> "$GITHUB_OUTPUT"

      - name: 重複リクエスト判定（Issue）
        id: dedupe
        env:
          GH_TOKEN: ${{ secrets.CROSS_REPO_GH_TOKEN || github.token }}
          TARGET_REPO: ${{ steps.payload.outputs.target_repo }}
          ISSUE_NUMBER: ${{ steps.payload.outputs.issue_number }}
          REQUEST_ID: ${{ steps.payload.outputs.request_id }}
        run: |
          set -euo pipefail

          echo "duplicate_request=false" >> "$GITHUB_OUTPUT"
          if [ -z "${REQUEST_ID:-}" ] || [ -z "${TARGET_REPO:-}" ] || [ -z "${ISSUE_NUMBER:-}" ]; then
            exit 0
          fi

          marker="flowsmith-request-id:${REQUEST_ID}"
          existing_id="$(
            gh api --paginate "repos/${TARGET_REPO}/issues/${ISSUE_NUMBER}/comments?per_page=100" \
              --jq ".[] | select((.body // \"\") | contains(\"${marker}\")) | .id" \
              | head -n 1 || true
          )"

          if [ -n "$existing_id" ]; then
            echo "duplicate_request=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          gh api -X POST "repos/${TARGET_REPO}/issues/${ISSUE_NUMBER}/comments" \
            -f "body=<!-- ${marker} -->" >/dev/null

      - name: サマリー（Issue）
        if: ${{ always() }}
        run: |
          {
            echo "## 受信ペイロード（Issue）"
            echo ""
            echo "- issue_number: \`${{ steps.payload.outputs.issue_number || '未指定' }}\`"
            echo "- project_id: \`${{ steps.payload.outputs.project_id || '未指定' }}\`"
            echo "- target_repo: \`${{ steps.payload.outputs.target_repo || '未指定' }}\`"
            echo "- base_branch: \`${{ steps.payload.outputs.base_branch || '未指定' }}\`"
            echo "- branch_name: \`${{ steps.payload.outputs.branch_name || '未指定' }}\`"
            echo "- no_sync: \`${{ steps.payload.outputs.no_sync || 'false' }}\`"
            echo "- duplicate_request: \`${{ steps.dedupe.outputs.duplicate_request || 'false' }}\`"
          } >> "$GITHUB_STEP_SUMMARY"

  run-agent:
    needs: validate-payload
    if: ${{ needs.validate-payload.outputs.duplicate_request != 'true' }}
    uses: ./.github/workflows/autonomous-agent-runner.yml
    with:
      dispatch_mode: issue
      issue_number: ${{ needs.validate-payload.outputs.issue_number }}
      project_id: ${{ needs.validate-payload.outputs.project_id }}
      target_repo: ${{ needs.validate-payload.outputs.target_repo }}
      base_branch: ${{ needs.validate-payload.outputs.base_branch }}
      branch_name: ${{ needs.validate-payload.outputs.branch_name }}
      codex_auth_json_b64: ${{ needs.validate-payload.outputs.codex_auth_json_b64 }}
      source_repository: ${{ needs.validate-payload.outputs.source_repository }}
      request_id: ${{ needs.validate-payload.outputs.request_id }}
      no_sync: ${{ needs.validate-payload.outputs.no_sync == 'true' }}
      allow_no_changes: false
    secrets: inherit
