name: 自律エージェント ディスパッチ受け口

on:
  repository_dispatch:
    types:
      - autonomous-agent-request

permissions:
  contents: write
  pull-requests: write
  issues: read

concurrency:
  group: dispatch-${{ github.event.client_payload.project_id || github.event.client_payload.target_repo || 'unknown' }}-${{ github.event.client_payload.issue_number || github.run_id }}
  cancel-in-progress: false

jobs:
  run-agent:
    runs-on: ubuntu-latest
    env:
      AGENT_PLANNER_CMD: ${{ secrets.AGENT_PLANNER_CMD }}
      AGENT_CODER_CMD: ${{ secrets.AGENT_CODER_CMD }}
      AGENT_REVIEWER_CMD: ${{ secrets.AGENT_REVIEWER_CMD }}
      AGENT_SETUP_SCRIPT: ${{ secrets.AGENT_SETUP_SCRIPT }}
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      CODEX_AUTH_JSON_B64: ${{ secrets.CODEX_AUTH_JSON_B64 }}
      FLOWSMITH_RUN_ARTIFACT_NAME: agent-run-${{ github.run_id }}-${{ github.run_attempt }}
    steps:
      - name: チェックアウト
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Python セットアップ
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Node.js セットアップ（エージェントCLI用）
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: 日本語フォントセットアップ（UI証跡用）
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            fonts-noto-cjk \
            fonts-ipafont-gothic \
            fonts-ipafont-mincho
          fc-cache -f

      - name: Codex CLI インストール（標準）
        run: |
          if command -v codex >/dev/null 2>&1; then
            codex --version
            exit 0
          fi
          npm install -g @openai/codex
          codex --version

      - name: Codex 認証設定
        run: |
          set -euo pipefail
          if [ -n "${CODEX_AUTH_JSON_B64:-}" ]; then
            mkdir -p "$HOME/.codex"
            printf '%s' "$CODEX_AUTH_JSON_B64" | base64 --decode > "$HOME/.codex/auth.json"
            chmod 600 "$HOME/.codex/auth.json"
            echo "Codex 認証: CODEX_AUTH_JSON_B64 を使用"
          elif [ -n "${OPENAI_API_KEY:-}" ]; then
            printf '%s' "$OPENAI_API_KEY" | codex login --with-api-key
            echo "Codex 認証: OPENAI_API_KEY を使用"
          else
            echo "OPENAI_API_KEY または CODEX_AUTH_JSON_B64 のいずれかを設定してください。" >&2
            exit 1
          fi
          codex login status

      - name: エージェントセットアップスクリプト実行（任意）
        if: ${{ env.AGENT_SETUP_SCRIPT != '' }}
        run: |
          set -euo pipefail
          printf '%s\n' "$AGENT_SETUP_SCRIPT" > /tmp/agent_setup.sh
          chmod +x /tmp/agent_setup.sh
          /tmp/agent_setup.sh

      - name: エージェントコマンド事前検証
        run: |
          python - <<'PY'
          import os
          import shlex
          import shutil
          import sys

          specs = [
              ("AGENT_PLANNER_CMD", True),
              ("AGENT_CODER_CMD", True),
              ("AGENT_REVIEWER_CMD", False),
          ]
          errors = []

          for key, required in specs:
              value = os.getenv(key, "").strip()
              if not value:
                  if required:
                      errors.append(f"{key} が未設定です。")
                  continue
              try:
                  parts = shlex.split(value)
              except ValueError as err:
                  errors.append(f"{key} のパースに失敗しました: {err}")
                  continue
              if not parts:
                  errors.append(f"{key} が空コマンドです。")
                  continue
              command = parts[0]
              if shutil.which(command) is None:
                  errors.append(
                      f"{key} の実行コマンド '{command}' が見つかりません。"
                  )

          if errors:
              print("[agent-preflight] コマンド検証に失敗しました。", file=sys.stderr)
              for item in errors:
                  print(f"- {item}", file=sys.stderr)
              raise SystemExit(1)
          PY

      - name: Entire CLI インストール（任意）
        if: ${{ vars.FLOWSMITH_ENABLE_ENTIRE == 'true' }}
        run: |
          curl -fsSL https://entire.io/install.sh | bash
          if command -v entire >/dev/null 2>&1; then
            entire version
            exit 0
          fi
          if [ -x "$HOME/.entire/bin/entire" ]; then
            echo "$HOME/.entire/bin" >> "$GITHUB_PATH"
            export PATH="$HOME/.entire/bin:$PATH"
          elif [ -x "$HOME/.local/bin/entire" ]; then
            echo "$HOME/.local/bin" >> "$GITHUB_PATH"
            export PATH="$HOME/.local/bin:$PATH"
          fi
          entire version

      - name: Git 実行ユーザー設定
        run: |
          git config --global user.name "flowsmith-agent[bot]"
          git config --global user.email "flowsmith-agent[bot]@users.noreply.github.com"

      - name: GitHub トークン解決
        run: |
          if [ -n "${{ secrets.CROSS_REPO_GH_TOKEN }}" ]; then
            echo "GH_TOKEN=${{ secrets.CROSS_REPO_GH_TOKEN }}" >> "$GITHUB_ENV"
          else
            echo "GH_TOKEN=${{ github.token }}" >> "$GITHUB_ENV"
          fi

      - name: Git 認証セットアップ
        run: |
          gh auth status
          gh auth setup-git

      - name: ディスパッチペイロード検証
        id: payload
        run: |
          issue_number="$(jq -r '.client_payload.issue_number // empty | tostring' "$GITHUB_EVENT_PATH")"
          project_id="$(jq -r '.client_payload.project_id // empty | tostring' "$GITHUB_EVENT_PATH")"
          target_repo="$(jq -r '.client_payload.target_repo // empty | tostring' "$GITHUB_EVENT_PATH")"
          base_branch="$(jq -r '.client_payload.base_branch // empty | tostring' "$GITHUB_EVENT_PATH")"
          branch_name="$(jq -r '.client_payload.branch_name // empty | tostring' "$GITHUB_EVENT_PATH")"
          feedback_pr_number="$(jq -r '.client_payload.feedback_pr_number // empty | tostring' "$GITHUB_EVENT_PATH")"
          feedback_text="$(jq -r '.client_payload.feedback_text // empty | tostring' "$GITHUB_EVENT_PATH")"
          no_sync_raw="$(jq -r '.client_payload.no_sync // false | tostring' "$GITHUB_EVENT_PATH")"
          source_repository="$(jq -r '.client_payload.source_repository // empty | tostring' "$GITHUB_EVENT_PATH")"
          request_id="$(jq -r '.client_payload.request_id // empty | tostring' "$GITHUB_EVENT_PATH")"

          if ! [[ "$issue_number" =~ ^[0-9]+$ ]]; then
            echo "client_payload.issue_number は正の整数で指定してください。" >&2
            exit 1
          fi

          if [ -z "$project_id" ] && [ -z "$target_repo" ]; then
            echo "client_payload.project_id または client_payload.target_repo のどちらかは必須です。" >&2
            exit 1
          fi

          if [ -n "$feedback_pr_number" ] && ! [[ "$feedback_pr_number" =~ ^[0-9]+$ ]]; then
            echo "client_payload.feedback_pr_number は正の整数で指定してください。" >&2
            exit 1
          fi

          expected_secret="${{ secrets.DISPATCH_SHARED_SECRET }}"
          if [ -n "$expected_secret" ]; then
            provided_secret="$(jq -r '.client_payload.dispatch_secret // empty | tostring' "$GITHUB_EVENT_PATH")"
            if [ -z "$provided_secret" ] || [ "$provided_secret" != "$expected_secret" ]; then
              echo "dispatch_secret の検証に失敗しました。" >&2
              exit 1
            fi
          fi

          no_sync="false"
          if [ "$no_sync_raw" = "true" ] || [ "$no_sync_raw" = "1" ]; then
            no_sync="true"
          fi

          echo "issue_number=$issue_number" >> "$GITHUB_OUTPUT"
          echo "project_id=$project_id" >> "$GITHUB_OUTPUT"
          echo "target_repo=$target_repo" >> "$GITHUB_OUTPUT"
          echo "base_branch=$base_branch" >> "$GITHUB_OUTPUT"
          echo "branch_name=$branch_name" >> "$GITHUB_OUTPUT"
          echo "feedback_pr_number=$feedback_pr_number" >> "$GITHUB_OUTPUT"
          {
            echo "feedback_text<<EOF"
            printf '%s\n' "$feedback_text"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"
          echo "no_sync=$no_sync" >> "$GITHUB_OUTPUT"
          echo "source_repository=$source_repository" >> "$GITHUB_OUTPUT"
          echo "request_id=$request_id" >> "$GITHUB_OUTPUT"

      - name: 自律パイプライン実行
        env:
          FEEDBACK_TEXT: ${{ steps.payload.outputs.feedback_text }}
        run: |
          cmd=(
            python scripts/agent_pipeline.py
            --issue-number "${{ steps.payload.outputs.issue_number }}"
            --push
            --create-pr
          )

          if [ -n "${{ steps.payload.outputs.project_id }}" ]; then
            cmd+=(--project "${{ steps.payload.outputs.project_id }}")
          fi

          if [ -n "${{ steps.payload.outputs.target_repo }}" ]; then
            cmd+=(--target-repo "${{ steps.payload.outputs.target_repo }}")
          fi

          if [ -n "${{ steps.payload.outputs.base_branch }}" ]; then
            cmd+=(--base-branch "${{ steps.payload.outputs.base_branch }}")
          fi

          if [ -n "${{ steps.payload.outputs.branch_name }}" ]; then
            cmd+=(--branch-name "${{ steps.payload.outputs.branch_name }}")
          fi

          if [ -n "${{ steps.payload.outputs.feedback_pr_number }}" ]; then
            cmd+=(--feedback-pr-number "${{ steps.payload.outputs.feedback_pr_number }}")
          fi

          if [ -n "${FEEDBACK_TEXT:-}" ]; then
            feedback_file="$RUNNER_TEMP/flowsmith-feedback-text.md"
            printf '%s\n' "$FEEDBACK_TEXT" > "$feedback_file"
            cmd+=(--feedback-file "$feedback_file")
          fi

          if [ "${{ steps.payload.outputs.no_sync }}" = "true" ]; then
            cmd+=(--no-sync)
          fi

          "${cmd[@]}"

      - name: 実行ディレクトリ特定
        id: run_dir
        if: ${{ always() }}
        run: |
          set -euo pipefail
          runs_root=".agent/runs"
          latest_run_dir=""
          if [ -d "$runs_root" ]; then
            latest_run_dir="$(ls -1dt "$runs_root"/*/* 2>/dev/null | head -n 1 || true)"
          fi
          echo "run_dir=$latest_run_dir" >> "$GITHUB_OUTPUT"
          echo "artifact_name=${FLOWSMITH_RUN_ARTIFACT_NAME}" >> "$GITHUB_OUTPUT"

      - name: 失敗時ログ出力
        id: debug_logs
        if: ${{ failure() }}
        run: |
          set -euo pipefail
          latest_run_dir="${{ steps.run_dir.outputs.run_dir }}"

          if [ -z "$latest_run_dir" ]; then
            echo "run_dir=" >> "$GITHUB_OUTPUT"
            echo "[debug] agent run directory was not found."
            exit 0
          fi

          echo "run_dir=$latest_run_dir" >> "$GITHUB_OUTPUT"
          echo "[debug] latest run dir: $latest_run_dir"
          echo "[debug] files:"
          find "$latest_run_dir" -maxdepth 1 -type f | sort

          if [ -f "$latest_run_dir/planner_command.log" ]; then
            echo "::group::planner_command.log"
            sed -n '1,240p' "$latest_run_dir/planner_command.log"
            echo "::endgroup::"
          fi

          if [ -f "$latest_run_dir/entire_enable.log" ]; then
            echo "::group::entire_enable.log"
            sed -n '1,160p' "$latest_run_dir/entire_enable.log"
            echo "::endgroup::"
          fi

      - name: 実行ログartifact保存
        if: ${{ always() && steps.run_dir.outputs.run_dir != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.run_dir.outputs.artifact_name }}
          path: ${{ steps.run_dir.outputs.run_dir }}
          if-no-files-found: warn
          retention-days: 7

      - name: ディスパッチサマリー出力
        if: ${{ always() }}
        run: |
          {
            echo "## ディスパッチリクエスト"
            echo ""
            echo "- issue_number: \`${{ steps.payload.outputs.issue_number }}\`"
            echo "- project_id: \`${{ steps.payload.outputs.project_id || '未指定' }}\`"
            echo "- target_repo: \`${{ steps.payload.outputs.target_repo || '未指定' }}\`"
            echo "- feedback_pr_number: \`${{ steps.payload.outputs.feedback_pr_number || '未指定' }}\`"
            echo "- source_repository: \`${{ steps.payload.outputs.source_repository || '未指定' }}\`"
            echo "- request_id: \`${{ steps.payload.outputs.request_id || '未指定' }}\`"
          } >> "$GITHUB_STEP_SUMMARY"
