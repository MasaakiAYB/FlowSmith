name: 自律エージェント 実行共通

on:
  workflow_call:
    inputs:
      dispatch_mode:
        description: "issue | feedback"
        required: true
        type: string
      issue_number:
        description: "対象Issue番号"
        required: true
        type: string
      project_id:
        description: "任意: .agent/projects.json の project id"
        required: false
        default: ""
        type: string
      target_repo:
        description: "任意: 対象リポジトリ(owner/repo)"
        required: false
        default: ""
        type: string
      base_branch:
        description: "任意: ベースブランチ"
        required: false
        default: ""
        type: string
      branch_name:
        description: "任意: 作業ブランチ"
        required: false
        default: ""
        type: string
      codex_auth_json_b64:
        description: "任意: 利用者auth.json(base64)"
        required: false
        default: ""
        type: string
      feedback_pr_number:
        description: "任意: 改善指摘抽出対象PR番号"
        required: false
        default: ""
        type: string
      feedback_text:
        description: "任意: 追加入力フィードバック"
        required: false
        default: ""
        type: string
      no_sync:
        description: "任意: 同期をスキップ"
        required: false
        default: false
        type: boolean
      allow_no_changes:
        description: "差分ゼロを成功扱いにする"
        required: false
        default: false
        type: boolean
      source_repository:
        description: "任意: 呼び出し元リポジトリ"
        required: false
        default: ""
        type: string
      request_id:
        description: "任意: リクエスト識別子"
        required: false
        default: ""
        type: string

permissions:
  contents: write
  pull-requests: write
  issues: write

concurrency:
  group: dispatch-${{ inputs.target_repo || inputs.project_id || 'unknown' }}-issue-${{ inputs.issue_number || github.run_id }}
  cancel-in-progress: false

jobs:
  acquire-lock:
    runs-on: ubuntu-latest
    concurrency:
      group: repo-lock-acquire-${{ inputs.target_repo || inputs.project_id || 'unknown' }}
      cancel-in-progress: false
    outputs:
      target_repo: ${{ steps.repo.outputs.target_repo }}
      lock_acquired: ${{ steps.acquire.outputs.lock_acquired }}
      lock_label: ${{ steps.acquire.outputs.lock_label }}
      service_label: ${{ steps.acquire.outputs.service_label }}
      operation_label: ${{ steps.acquire.outputs.operation_label }}
    steps:
      - name: チェックアウト
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Python セットアップ
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: GitHub トークン解決
        run: |
          if [ -n "${{ secrets.CROSS_REPO_GH_TOKEN }}" ]; then
            echo "GH_TOKEN=${{ secrets.CROSS_REPO_GH_TOKEN }}" >> "$GITHUB_ENV"
          else
            echo "GH_TOKEN=${{ github.token }}" >> "$GITHUB_ENV"
          fi

      - name: 対象リポジトリ解決
        id: repo
        env:
          PROJECT_ID: ${{ inputs.project_id }}
        run: |
          set -euo pipefail
          target_repo="${{ inputs.target_repo }}"

          if [ -z "$target_repo" ] && [ -n "${PROJECT_ID:-}" ]; then
            target_repo="$(
              PROJECT_ID="$PROJECT_ID" python -c 'import json, os; from pathlib import Path; project_id=os.getenv("PROJECT_ID", "").strip(); payload=json.loads(Path(".agent/projects.json").read_text(encoding="utf-8")) if project_id else {}; project=payload.get("projects", {}).get(project_id, {}) if isinstance(payload, dict) else {}; print(str(project.get("repo", "")).strip() if isinstance(project, dict) else "")'
            )"
          fi

          if [ -z "$target_repo" ]; then
            echo "target_repo を解決できませんでした。inputs.target_repo か inputs.project_id を確認してください。" >&2
            exit 1
          fi

          echo "target_repo=$target_repo" >> "$GITHUB_OUTPUT"

      - name: ロック取得（queue + exclusive）
        id: acquire
        env:
          TARGET_REPO: ${{ steps.repo.outputs.target_repo }}
        run: |
          set -euo pipefail
          python scripts/agent_lock.py acquire \
            --repo "$TARGET_REPO" \
            --issue-number "${{ inputs.issue_number }}" \
            --lock-label "${{ vars.FLOWSMITH_LOCK_LABEL || 'agent/running' }}" \
            --max-parallel "${{ vars.FLOWSMITH_MAX_PARALLEL_PER_REPO || '2' }}" \
            --poll-seconds "${{ vars.FLOWSMITH_LOCK_POLL_SECONDS || '20' }}" \
            --timeout-minutes "${{ vars.FLOWSMITH_LOCK_TIMEOUT_MINUTES || '180' }}" \
            --stale-minutes "${{ vars.FLOWSMITH_LOCK_STALE_MINUTES || '360' }}" \
            --cooldown-minutes "${{ vars.FLOWSMITH_OPERATION_COOLDOWN_MINUTES || '30' }}" \
            --service-label-prefix "${{ vars.FLOWSMITH_SERVICE_LABEL_PREFIX || 'agent/service:' }}" \
            --operation-label-prefix "${{ vars.FLOWSMITH_OPERATION_LABEL_PREFIX || 'agent/op:' }}"

  run-agent:
    needs: acquire-lock
    if: ${{ needs.acquire-lock.outputs.lock_acquired == 'true' }}
    runs-on: ubuntu-latest
    env:
      AGENT_PLANNER_CMD: ${{ secrets.AGENT_PLANNER_CMD }}
      AGENT_CODER_CMD: ${{ secrets.AGENT_CODER_CMD }}
      AGENT_REVIEWER_CMD: ${{ secrets.AGENT_REVIEWER_CMD }}
      AGENT_SETUP_SCRIPT: ${{ secrets.AGENT_SETUP_SCRIPT }}
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      CODEX_AUTH_JSON_B64_SECRET: ${{ secrets.CODEX_AUTH_JSON_B64 }}
      CODEX_AUTH_JSON_B64_INPUT: ${{ inputs.codex_auth_json_b64 }}
      TARGET_REPO_RESOLVED: ${{ needs.acquire-lock.outputs.target_repo }}
      FLOWSMITH_RUN_ARTIFACT_NAME: agent-run-${{ github.run_id }}-${{ github.run_attempt }}
    steps:
      - name: チェックアウト
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Python セットアップ
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Node.js セットアップ（エージェントCLI用）
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: 日本語フォントセットアップ（UI証跡用）
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            fonts-noto-cjk \
            fonts-ipafont-gothic \
            fonts-ipafont-mincho
          fc-cache -f

      - name: Codex CLI インストール（標準）
        run: |
          if command -v codex >/dev/null 2>&1; then
            codex --version
            exit 0
          fi
          npm install -g @openai/codex
          codex --version

      - name: Codex 認証設定
        run: |
          set -euo pipefail
          resolved_auth_json_b64="${CODEX_AUTH_JSON_B64_INPUT:-}"
          auth_source="workflow input codex_auth_json_b64"

          if [ -z "$resolved_auth_json_b64" ]; then
            resolved_auth_json_b64="${CODEX_AUTH_JSON_B64_SECRET:-}"
            auth_source="repository secret CODEX_AUTH_JSON_B64"
          fi

          if [ -n "$resolved_auth_json_b64" ]; then
            echo "::add-mask::$resolved_auth_json_b64"
            mkdir -p "$HOME/.codex"
            printf '%s' "$resolved_auth_json_b64" | base64 --decode > "$HOME/.codex/auth.json"
            chmod 600 "$HOME/.codex/auth.json"
            echo "Codex 認証: ${auth_source} を使用"
          elif [ -n "${OPENAI_API_KEY:-}" ]; then
            printf '%s' "$OPENAI_API_KEY" | codex login --with-api-key
            echo "Codex 認証: OPENAI_API_KEY を使用"
          else
            echo "OPENAI_API_KEY または CODEX_AUTH_JSON_B64 のいずれかを設定してください。" >&2
            exit 1
          fi
          codex login status

      - name: エージェントセットアップスクリプト実行（任意）
        if: ${{ env.AGENT_SETUP_SCRIPT != '' }}
        run: |
          set -euo pipefail
          printf '%s\n' "$AGENT_SETUP_SCRIPT" > /tmp/agent_setup.sh
          chmod +x /tmp/agent_setup.sh
          /tmp/agent_setup.sh

      - name: エージェントコマンド事前検証
        run: |
          python - <<'PY'
          import os
          import shlex
          import shutil
          import sys

          specs = [
              ("AGENT_PLANNER_CMD", True),
              ("AGENT_CODER_CMD", True),
              ("AGENT_REVIEWER_CMD", False),
          ]
          errors = []

          for key, required in specs:
              value = os.getenv(key, "").strip()
              if not value:
                  if required:
                      errors.append(f"{key} が未設定です。")
                  continue
              try:
                  parts = shlex.split(value)
              except ValueError as err:
                  errors.append(f"{key} のパースに失敗しました: {err}")
                  continue
              if not parts:
                  errors.append(f"{key} が空コマンドです。")
                  continue
              command = parts[0]
              if shutil.which(command) is None:
                  errors.append(
                      f"{key} の実行コマンド '{command}' が見つかりません。"
                  )

          if errors:
              print("[agent-preflight] コマンド検証に失敗しました。", file=sys.stderr)
              for item in errors:
                  print(f"- {item}", file=sys.stderr)
              raise SystemExit(1)
          PY

      - name: Entire CLI インストール（任意）
        if: ${{ vars.FLOWSMITH_ENABLE_ENTIRE == 'true' }}
        run: |
          curl -fsSL https://entire.io/install.sh | bash
          if command -v entire >/dev/null 2>&1; then
            entire version
            exit 0
          fi
          if [ -x "$HOME/.entire/bin/entire" ]; then
            echo "$HOME/.entire/bin" >> "$GITHUB_PATH"
            export PATH="$HOME/.entire/bin:$PATH"
          elif [ -x "$HOME/.local/bin/entire" ]; then
            echo "$HOME/.local/bin" >> "$GITHUB_PATH"
            export PATH="$HOME/.local/bin:$PATH"
          fi
          entire version

      - name: Git 実行ユーザー設定
        run: |
          git config --global user.name "flowsmith-agent[bot]"
          git config --global user.email "flowsmith-agent[bot]@users.noreply.github.com"

      - name: GitHub トークン解決
        run: |
          if [ -n "${{ secrets.CROSS_REPO_GH_TOKEN }}" ]; then
            echo "GH_TOKEN=${{ secrets.CROSS_REPO_GH_TOKEN }}" >> "$GITHUB_ENV"
          else
            echo "GH_TOKEN=${{ github.token }}" >> "$GITHUB_ENV"
          fi

      - name: Git 認証セットアップ
        run: |
          gh auth status
          gh auth setup-git

      - name: 自律パイプライン実行
        env:
          FEEDBACK_TEXT: ${{ inputs.feedback_text }}
        run: |
          cmd=(
            python scripts/agent_pipeline.py
            --issue-number "${{ inputs.issue_number }}"
            --push
            --create-pr
          )

          if [ -n "${{ inputs.project_id }}" ]; then
            cmd+=(--project "${{ inputs.project_id }}")
          fi

          if [ -n "${TARGET_REPO_RESOLVED:-}" ]; then
            cmd+=(--target-repo "$TARGET_REPO_RESOLVED")
          fi

          if [ -n "${{ inputs.base_branch }}" ]; then
            cmd+=(--base-branch "${{ inputs.base_branch }}")
          fi

          if [ -n "${{ inputs.branch_name }}" ]; then
            cmd+=(--branch-name "${{ inputs.branch_name }}")
          fi

          if [ -n "${{ inputs.feedback_pr_number }}" ]; then
            cmd+=(--feedback-pr-number "${{ inputs.feedback_pr_number }}")
          fi

          if [ -n "${FEEDBACK_TEXT:-}" ]; then
            feedback_file="$RUNNER_TEMP/flowsmith-feedback-text.md"
            printf '%s\n' "$FEEDBACK_TEXT" > "$feedback_file"
            cmd+=(--feedback-file "$feedback_file")
          fi

          if [ "${{ inputs.no_sync }}" = "true" ]; then
            cmd+=(--no-sync)
          fi

          if [ "${{ inputs.allow_no_changes }}" = "true" ]; then
            cmd+=(--allow-no-changes)
          fi

          "${cmd[@]}"

      - name: 実行ディレクトリ特定
        id: run_dir
        if: ${{ always() }}
        run: |
          set -euo pipefail
          runs_root=".agent/runs"
          latest_run_dir=""
          if [ -d "$runs_root" ]; then
            latest_run_dir="$(ls -1dt "$runs_root"/*/* 2>/dev/null | head -n 1 || true)"
          fi
          echo "run_dir=$latest_run_dir" >> "$GITHUB_OUTPUT"
          echo "artifact_name=${FLOWSMITH_RUN_ARTIFACT_NAME}" >> "$GITHUB_OUTPUT"

      - name: 失敗時ログ出力
        id: debug_logs
        if: ${{ failure() }}
        run: |
          set -euo pipefail
          latest_run_dir="${{ steps.run_dir.outputs.run_dir }}"

          if [ -z "$latest_run_dir" ]; then
            echo "run_dir=" >> "$GITHUB_OUTPUT"
            echo "[debug] agent run directory was not found."
            exit 0
          fi

          echo "run_dir=$latest_run_dir" >> "$GITHUB_OUTPUT"
          echo "[debug] latest run dir: $latest_run_dir"
          echo "[debug] files:"
          find "$latest_run_dir" -maxdepth 1 -type f | sort

          if [ -f "$latest_run_dir/planner_command.log" ]; then
            echo "::group::planner_command.log"
            sed -n '1,240p' "$latest_run_dir/planner_command.log"
            echo "::endgroup::"
          fi

          if [ -f "$latest_run_dir/entire_enable.log" ]; then
            echo "::group::entire_enable.log"
            sed -n '1,160p' "$latest_run_dir/entire_enable.log"
            echo "::endgroup::"
          fi

      - name: 実行ログartifact保存
        if: ${{ always() && steps.run_dir.outputs.run_dir != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.run_dir.outputs.artifact_name }}
          path: ${{ steps.run_dir.outputs.run_dir }}
          if-no-files-found: warn
          retention-days: 7

      - name: ディスパッチサマリー出力
        if: ${{ always() }}
        run: |
          {
            echo "## ディスパッチリクエスト"
            echo ""
            echo "- mode: \`${{ inputs.dispatch_mode }}\`"
            echo "- issue_number: \`${{ inputs.issue_number }}\`"
            echo "- project_id: \`${{ inputs.project_id || '未指定' }}\`"
            echo "- target_repo: \`${TARGET_REPO_RESOLVED:-未指定}\`"
            echo "- branch_name: \`${{ inputs.branch_name || '未指定' }}\`"
            echo "- feedback_pr_number: \`${{ inputs.feedback_pr_number || '未指定' }}\`"
            echo "- allow_no_changes: \`${{ inputs.allow_no_changes }}\`"
            echo "- source_repository: \`${{ inputs.source_repository || '未指定' }}\`"
            echo "- request_id: \`${{ inputs.request_id || '未指定' }}\`"
          } >> "$GITHUB_STEP_SUMMARY"

  release-lock:
    needs:
      - acquire-lock
      - run-agent
    if: ${{ always() && needs.acquire-lock.outputs.lock_acquired == 'true' }}
    runs-on: ubuntu-latest
    concurrency:
      group: repo-lock-acquire-${{ inputs.target_repo || inputs.project_id || 'unknown' }}
      cancel-in-progress: false
    steps:
      - name: チェックアウト
        uses: actions/checkout@v4

      - name: Python セットアップ
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: GitHub トークン解決
        run: |
          if [ -n "${{ secrets.CROSS_REPO_GH_TOKEN }}" ]; then
            echo "GH_TOKEN=${{ secrets.CROSS_REPO_GH_TOKEN }}" >> "$GITHUB_ENV"
          else
            echo "GH_TOKEN=${{ github.token }}" >> "$GITHUB_ENV"
          fi

      - name: ロック解放
        env:
          TARGET_REPO: ${{ needs.acquire-lock.outputs.target_repo }}
          LOCK_LABEL: ${{ needs.acquire-lock.outputs.lock_label }}
          SERVICE_LABEL: ${{ needs.acquire-lock.outputs.service_label }}
          OPERATION_LABEL: ${{ needs.acquire-lock.outputs.operation_label }}
        run: |
          set -euo pipefail
          record_flag=""
          if [ -n "${SERVICE_LABEL:-}" ] && [ -n "${OPERATION_LABEL:-}" ]; then
            record_flag="--record-operation"
          fi

          python scripts/agent_lock.py release \
            --repo "$TARGET_REPO" \
            --issue-number "${{ inputs.issue_number }}" \
            --lock-label "${LOCK_LABEL:-agent/running}" \
            --service-label "${SERVICE_LABEL:-}" \
            --operation-label "${OPERATION_LABEL:-}" \
            $record_flag
